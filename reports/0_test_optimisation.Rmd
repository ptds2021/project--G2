---
title: "Goals and Impacts"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
runtime: shiny
---

```{r, warning=FALSE, include=FALSE, echo=FALSE}
source(here::here("scripts/setup.R"))

## Initial Cleaning of Data
HEC_timetables_initial <- read_excel(here::here("data/HEC_timetables.xlsx"), 
 col_names = c("Start", "NA", "End", "NA", "Class", "NA", "Prof"), 
 col_types = c("text", "skip", "numeric", "skip", "text", "skip", "text")) %>%
  mutate(Day =  Start, 
         Credit = Prof, 
         Day = gsub("[0-9]+", NA, Day), 
         Credit =as.numeric(gsub("*?([0-9]+).*", "\\1", Prof))) %>% 
  fill(Day, .direction = c("down")) %>%
  fill(Credit, .direction = c("up")) %>%
  na.omit() %>%
  mutate(Start_nice = chron::times(as.numeric(Start)), 
         End_nice = chron::times(as.numeric(End)),
         Start = as.numeric(Start)*24, 
         End = as.numeric(End)*24, 
         Credit = ifelse(as.numeric(Credit)==1, 1.5, Credit), 
         
         # Business Analytics (dummy = 1) or not (dummy = 0)
         BA = c(0,1,0,0,0,1,0,0,0,0,0,0,1,0,1,0,0,0,0,0,
                       0,0,0,0,0,0,1,0,0,0,1,1,0,0,1,0,0,0), 
         BA_credits = BA*Credit,  # Total of credits per class in BA
         
         # Management (elective) (dummy = 1) or not (dummy = 0)
         MG = ifelse(BA == 1, 0, 1),
         MG_credits = MG * Credit,  # Total of credits per class in Management (MG)
         
         Day = recode(  # Recode days in number (1=Monday, 5=Friday)
           as.factor(Day),
           "Lundi" = 1,
           "Mardi" = 2,
           "Mercredi" = 3,
           "Jeudi" = 4,
           "Vendredi" = 5), 
         Moment = as.factor(paste0(
           Day, "_", as.factor(ifelse(End <=12, "AM", "PM")))))
```

```{r, warning=FALSE, include=FALSE, echo=FALSE}
# Replicate 11 times Monday (1), Tuesday, Wednesday, Thursday and Friday (5)
a <- c(rep(1, 11), rep(2, 11), rep(3, 11), rep(4, 11), rep(5, 11))

# Replication 5 times all the hours slots from 8 to 19
b <- rep(9:19, 5)

# Create a list with all conditions for hours and day combinations
cols_to_make <-rlang::parse_exprs(
  paste0('ifelse(Start<',b,'& End >=',b,'& Day==',a,',1,0)'))

################ CREATION OF DUMMY VARIABLES USED 

HEC_timetables_dummies <- HEC_timetables_initial %>%
  select(-Start_nice, -End_nice) %>%
  fastDummies::dummy_cols(., c("Class", "Moment")) %>%
  select(-Moment) %>%
  rowwise(.) %>%
  mutate(!!!cols_to_make)  %>%
  ungroup 

#names(HEC_timetables_dummies) <- sub("Moment_", "", names(HEC_timetables_dummies))
#names(HEC_timetables_dummies) <- sub("Class_", "", names(HEC_timetables_dummies))
#names(HEC_timetables_dummies) <- sub("ifelse", "", names(HEC_timetables_dummies))
```

```{r, warning=FALSE}
library("shiny")
library("lpSolve")
library("chron")

# Define UI for application that draws a histogram
ui <- fluidPage(# Application title
  titlePanel("HEC Timetable"),
  
  # Sidebar to insert user choices
  sidebarLayout(
    
    sidebarPanel(
      # Period of the day
      checkboxInput(inputId = "monday_morning", label = "Monday morning", value = TRUE),
      checkboxInput(inputId = "monday_afternoon", label = "Monday afternoon", value = TRUE),
      checkboxInput(inputId = "tuesday_morning", label = "Tuesday morning", value = TRUE),
      checkboxInput(inputId = "tuesday_afternoon", label = "Tuesday afternoon", value = TRUE),
      checkboxInput(inputId = "wednesday_morning", label = "Wednesday morning", value = TRUE),
      checkboxInput(inputId = "wednesday_afternoon", label = "Wednesday afternoon", value = TRUE),
      checkboxInput(inputId = "thursday_morning", label = "Thursday morning", value = TRUE),
      checkboxInput(inputId = "thursday_afternoon", label = "Thursday afternoon", value = TRUE),
      checkboxInput(inputId = "friday_morning", label = "Friday morning", value = TRUE),
      checkboxInput(inputId = "friday_afternoon", label = "Friday afternoon", value = TRUE),
      
     # Credits requirement
      sliderInput(inputId = "credits", 
      min = 0, max = 60, value = 30, label = "Number of total credits"),
      sliderInput(inputId = "BA_credits", 
      min = 0, max = 36, value = 15, label = "Number of BA credits"),
      sliderInput(inputId = "MG_credits",  
      min = 0, max = 24, value = 12, label = "Number of Electives ECTS credits")
     
    ),
    # Show a plot of the generated distribution
    mainPanel(tableOutput(outputId = "timetable"))
  ))

server <- function(input, output, session) {
  
  # Define parameters
  nb_of_class <- length(HEC_timetables_dummies$Class)
  nb_of_timeslot <- 55L # 11 time slot per day, times 5 days a week
  
  # Set matrix corresponding to coefficients of constraints
  f.con <- HEC_timetables_dummies %>%
    # Removed column that are not needed in the constraints
    select(-Start, -End, -Class, -Prof, -Day, -BA, -MG) %>% t()
  
  # Set coefficients of the objective function (min total credits taken)
  f.obj  <- HEC_timetables_dummies$Credit
    
  # Credit requirement
  credits <- reactive(input$credits)
  BA_credits <- reactive(input$BA_credits)
  MG_credits <- reactive(input$MG_credits)
  
  # Period of the day
  monday_morning <- reactive(input$monday_morning)
  monday_afternoon <- reactive(input$monday_afternoon)
  tuesday_morning <- reactive(input$tuesday_morning)
  tuesday_afternoon <- reactive(input$tuesday_afternoon)
  wednesday_morning <- reactive(input$wednesday_morning)
  wednesday_afternoon <- reactive(input$wednesday_afternoon)
  thursday_morning <- reactive(input$thursday_morning)
  thursday_afternoon <- reactive(input$thursday_afternoon)
  friday_morning <- reactive(input$friday_morning)
  friday_afternoon <- reactive(input$friday_afternoon)

  output$timetable <- renderTable({
    
    # Set unequality/equality signs
    f.dir <- c(
      ### USER CHOICES
      #### CREDITS -> Should be greater than threshold given by user
      ">=", # Credits constraint
      ">=", # BA Credits constraint
      ">=", # MG Credits constraint
      
      #### CLASS -> By default possible, put == (double) instead if WANT the class
      "<=", # "Advanced issues in International and European Tax Law"
      "<=", # "Algorithms for Business Intelligence and Digital Marketing"
      "<=", # "Animal Communication and Parasitism"
      "<=", # "Behavioral Economics"
      "<=", # "Business and Human Rights"
      "<=", # "Business and Society - Corporate Sustainability"
      "<=", # "Business Case en Marketing"
      "<=", # "Datascience for Marketing"
      "<=", # "Digitalisation of Purchasing and B to B Sales"
      "<=", # "Entrepreneurship and Strategy"
      "<=", # "Entrepreneurship, Innovation and Control Systems"
      "<=", # "Experimental Methods"
      "<=", # "Fraud and Business Process Analytics"
      "<=", # "Global Marketing"
      "<=", # "Heuristic Decision Making Strategies"
      "<=", # "Human Behavior and Evolutionary Inference"
      "<=", # "Individual Behavior in the Digital Environment"
      "<=", # "Integrated Marketing Communication (MScM)"
      "<=", # "La recherche dans tous ses états"
      "<=", # "Leadership Development"
      "<=", # "Luxury Marketing"
      "<=", # "Major Transition in Evolution"
      "<=", # "Managerial Decision Making"
      "<=", # "Normes comptables internationales (IFRS)"
      "<=", # "Production Control"
      "<=", # "Programming Tools in Data Science"
      "<=", # "Project in Data Analytics"
      "<=", # "Risk Analytics"
      "<=", # "Strategic Management Control Systems"
      "<=", # "Stratégies digitales"
      "<=", # "Stratégies légales internationales I"
      "<=", # "Stratégies légales internationales II"
      "<=", # "Strategy and Development Modes"
      "<=", # "Strategy in Digital Markets"
      "<=", # "Supply Chain Management and its Latest Trends"
      "<=", # "Text Mining"
      "<=", # "Unethical Decision Making - Advanced"
      "<=", # "Unethical Decision Making - Basics"
      
      #### CHUNK OF THE DAY/WEEK
      "<=", # Monday Morning
      "<=", # Monday Afternoon
      "<=", # Tuesday Morning
      "<=", # Tuesday Afternoon
      "<=", # Wednesday Morning
      "<=", # Wednesday Afternoon
      "<=", # Thursday Morning
      "<=", # Thursday Afternoon
      "<=", # Friday Morning
      "<=", # Friday Afternoon
      
      ### TIME CONSTRAINTS
      rep.int("<=", nb_of_timeslot) # Time slot constraint <= 1 (no overlap allowed)
    )
    
    # Set right hand side coefficients
    f.rhs <- c(
      ### USER CHOICES
      
      #### CREDITS -> Should be greater than threshold given by user
      credits(),     # Credits constraint
      BA_credits(),  # BA Credits constraint
      MG_credits(),  # MG Credits constraint
      
      #### CLASS
      rep.int(1, nb_of_class), # Diagonal matrix for each class
      
      #### CHUNK OF THE DAY/WEEK -> By default allowed (TRUE), put FALSE if don't want
      monday_morning(), # Monday Morning class
      monday_afternoon(), # Monday Afternoon class
      tuesday_morning(), # Tuesday Morning class
      tuesday_afternoon(), # Tuesday Afternoon class
      wednesday_morning(), # Wednesday Morning class
      wednesday_afternoon(), # Wednesday Afternoon class
      thursday_morning(), # Thursday Morning class
      thursday_afternoon(), # Thursday Afternoon class
      friday_morning(), # Friday Morning class
      friday_afternoon(), # Friday Afternoon class
      
      ### TIME CONSTRAINTS
      rep.int(1, nb_of_timeslot) # Time slot constraint <= 1 (no overlap allowed)
    )
    
    # Variables choices (1 if class is taken, 0 otherwise)
    timetable <- lp("min", f.obj, f.con, f.dir, f.rhs, all.bin = TRUE)$solution %>%
      as_tibble() %>%
      cbind(HEC_timetables_initial %>%
              mutate(
                Start = as.character(Start_nice),
                End = as.character(End_nice), 
                Day = recode_factor(Day, 
                             `1` = "Monday", 
                             `2` = "Tuesday",
                             `3` = "Wednesday",
                             `4` = "Thursday",
                             `5` = "Friday")
              ) %>%
              select(Class, -Start_nice, Start, -End_nice, 
                     End, Prof, Day, Credit, BA)) %>%
     filter(. > 0)  %>%
     select(Class, Start, End, Prof, Day, Credit, BA)
      
  })
}

shinyApp(ui, server)
```
