---
title: "Goals and Impacts"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
runtime: shiny
---

```{r, warning=FALSE, include=FALSE, echo=FALSE}
source(here::here("scripts/setup.R"))
# Replication 5 times all the hours slots from 8 to 19
hours_of_day <- rep(9:19, 5)

# Replicate 11 times Monday (1), Tuesday, Wednesday, Thursday and Friday (5)
days_of_week <-c(rep(1, 11), rep(2, 11), rep(3, 11), rep(4, 11), rep(5, 11))

# Create a list with all conditions for hours and day combinations
cols_to_make <- rlang::parse_exprs(
  paste0('ifelse(
         Start <', hours_of_day, 
         '& End >=', hours_of_day,
         '& Day ==', days_of_week, ',1,0)'))
```

# Semester 1
```{r, warning=FALSE, include=FALSE, echo=FALSE}
## Initial Cleaning of Data
HEC_timetables_semester_1 <- read_excel(here::here("data/HEC_timetables.xlsx"), sheet = 1, 
 col_names = c("Start", "NA", "End", "NA", "Class", "NA", "Prof"), 
 col_types = c("text", "skip", "text", "skip", "text", "skip", "text")) %>%
  mutate(Day =  Start, 
         Credit = Prof, 
         Day = gsub("[0-9]+", NA, Day), 
         Credit =as.numeric(gsub("*?([0-9]+).*", "\\1", Prof))) %>% 
  fill(Day, .direction = c("down")) %>%
  fill(Credit, .direction = c("up")) %>%
  na.omit() %>%
  mutate(Start_nice = chron::times(as.numeric(Start)), 
         End_nice = chron::times(as.numeric(End)),
         Start = as.numeric(Start)*24, 
         End = as.numeric(End)*24, 
         Credit = ifelse(as.numeric(Credit)==1, 1.5, Credit), 
         BA = c(0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1),  # Business Analytics 
         BA_credits = BA*Credit,  # Total of credits per class in BA
         MG = ifelse(BA == 1, 0, 1), # Management (elective)
         MG_credits = MG * Credit,  # Total of credits per class in Management (MG)
         Day = recode(  # Recode days in number (1=Monday, 5=Friday)
           as.factor(Day),
           "Lundi" = 1,
           "Mardi" = 2,
           "Mercredi" = 3,
           "Jeudi" = 4,
           "Vendredi" = 5), 
         Moment = as.factor(paste0(
           Day, "_", as.factor(ifelse(End <=12, "AM", "PM")))))
```
## Dummies varibles 
```{r, warning=FALSE, include=FALSE, echo=FALSE}
HEC_timetables_dummies_1 <- HEC_timetables_semester_1 %>%
  rowwise(.) %>%
  mutate(!!!cols_to_make)  %>%
  ungroup %>% 
  pivot_longer(cols=starts_with("ifelse")) %>%
  filter(value!=0) %>% 
  select(-value) %>%
  fastDummies::dummy_cols(., c("Moment", "name")) %>%
  select(-Moment, -Start_nice, -End_nice, -Moment, -name, 
         -Start, -End, -Prof, -Day, -BA, -MG)

uniques_1 <-HEC_timetables_dummies_1$Class

HEC_timetables_dummies_1 <- HEC_timetables_dummies_1 %>%
  fastDummies::dummy_cols(., c("Class")) %>% 
  select(-Class) %>% t() %>% as.data.frame()

colnames(HEC_timetables_dummies_1) <- uniques_1
constraints_1 <- row.names(HEC_timetables_dummies_1)

HEC_timetables_dummies_1 <- data.frame(sapply(split(1:ncol(HEC_timetables_dummies_1), 
                                                    colnames(HEC_timetables_dummies_1)), 
                                              function(i) do.call(pmax, HEC_timetables_dummies_1[i])))
row.names(HEC_timetables_dummies_1) <- constraints_1

colnames(HEC_timetables_dummies_1) <- row.names(HEC_timetables_dummies_1 %>%
   filter(grepl("Class_", rownames(HEC_timetables_dummies_1))))
colnames(HEC_timetables_dummies_1) <- gsub("Class_","",colnames(HEC_timetables_dummies_1))

#write.xlsx(HEC_timetables_dummies_1, file = "HEC_timetables_dummies_1.xlsx")

classes_semester_1 <- colnames(HEC_timetables_dummies_1)

moments_semester_1 <- levels(HEC_timetables_semester_1$Moment)
moments_semester_1 <- sub("1_","Monday ",moments_semester_1)
moments_semester_1 <- sub("2_","Tuesday ",moments_semester_1)
moments_semester_1 <- sub("3_","Wednesday ",moments_semester_1)
moments_semester_1 <- sub("4_","Thursday ",moments_semester_1)
moments_semester_1 <- sub("5_","Friday ",moments_semester_1)
```
## Shiny App  
### UI
```{r, warning=FALSE}
ui1 <- fluidPage(# Application title
  titlePanel("HEC Timetable"),
  sidebarLayout(
    # Sidebar to insert user choices
    sidebarPanel(
      #Classes choices
      checkboxGroupInput(
        inputId = "Classes",
        label = "Classes:",
        choices = classes_semester_1,
        selected = c("Quantitative Methods for Management")),
      # Moments choices
      checkboxGroupInput(
        inputId = "Moments",
        label = "Day - AM/PM:",
        choices = moments_semester_1,
        selected = moments_semester_1),
      # ECTS choices
      sliderInput(inputId = "credits",
        min = 0, max = 42, value = 30, label = "Number of total credits"),
      sliderInput(inputId = "BA_credits",
        min = 0, max = 36, value = 12,
        label = "Number of BA credits"),
      sliderInput(inputId = "MG_credits", 
        min = 0, max = 24, value = 18, label = "Number of Electives ECTS credits")),
    # Show a plot of the generated distribution
    mainPanel(tableOutput(outputId = "timetable"))
  )
)
```
### Server
```{r, warning=FALSE}
server1 <- function(input, output, session) {
  
  output$timetable <- renderTable({
  # Credit requirement
  credits <- reactive(input$credits)
  BA_credits <- reactive(input$BA_credits)
  MG_credits <- reactive(input$MG_credits)  
    
  # Period of the day
  moments_constraints <- vector(length=length(moments_semester_1))
  Moments <- reactive(input$Moments)
  for (i in 1:length(moments_semester_1)) {
    moments_constraints[i] <- moments_semester_1[i] %in%  Moments()
  }
    
  classes_constraints <- vector(length=length(classes_semester_1))
  Classes <- reactive(input$Classes)
  for (i in 1:length(classes_semester_1)) {
    classes_constraints[i] <- classes_semester_1[i] %in%  Classes()
  }
  
  # Define parameters
  nb_of_class <- ncol(HEC_timetables_dummies_1)
  nb_of_timeslot <- dim(HEC_timetables_dummies_1 %>%
  filter(grepl("ifelse", rownames(HEC_timetables_dummies_1))))[1]
  nb_of_moment <- length(row.names(HEC_timetables_dummies_1 %>%
  filter(grepl("AM|PM", rownames(HEC_timetables_dummies_1)))))

  # Set matrix corresponding to coefficients of constraints
  f.con <- HEC_timetables_dummies_1 
  
  # Set coefficients of the objective function (min total credits taken)
  f.obj  <- HEC_timetables_dummies_1[1,] %>% unname() %>% unlist()
    
  # Set unequality/equality signs
  f.dir <- c(
    ">=", # Credits constraint
    ">=", # BA Credits constraint
    ">=", # MG Credits constraint
    rep("<=", nb_of_moment), # Chunk of the day
    rep.int("<=", nb_of_timeslot), # Time constraints
    rep(">=", nb_of_class)) # Classes choices
  
    # Set right hand side coefficients
  f.rhs <- c(
    credits(),    # Credits constraint
    BA_credits(), # BA Credits constraint
    MG_credits(), # MG Credits constraint
    moments_constraints, # Chunk of the day constraints
    rep.int(1, nb_of_timeslot), # Time constraints
    classes_constraints) # Classes constraints
    
    # Variables choices (1 if class is taken, 0 otherwise)
    binary  <- lp("min", f.obj, f.con, f.dir, f.rhs, all.bin = TRUE)$solution
    
    timetable <- cbind(as.numeric(binary), 
                       colnames(HEC_timetables_dummies_1)) %>%
      as.data.frame() %>%
      mutate(Choice = V1, Class = V2) %>%
      left_join(HEC_timetables_semester_1) %>%
      filter(Choice == 1) %>%
      mutate(
        Start = as.character(Start_nice),
        End = as.character(End_nice),
        Day = recode_factor(Day,
          `1` = "Monday",
          `2` = "Tuesday",
          `3` = "Wednesday",
          `4` = "Thursday",
          `5` = "Friday"),
        BA = recode(BA, 
          `1` = "Yes",
          `0` = "No")
      ) %>%
      select(Class, Start, End, Prof, Day, Credit, BA)
  })
}

shinyApp(ui1, server1)
```

# Semester 2 
```{r, warning=FALSE, include=FALSE, echo=FALSE}
## Initial Cleaning of Data
HEC_timetables_semester_2 <- read_excel(here::here("data/HEC_timetables.xlsx"), sheet = 2, 
 col_names = c("Start", "NA", "End", "NA", "Class", "NA", "Prof"), 
 col_types = c("text", "skip", "text", "skip", "text", "skip", "text")) %>%
  mutate(Day =  Start, 
         Credit = Prof, 
         Day = gsub("[0-9]+", NA, Day), 
         Credit =as.numeric(gsub("*?([0-9]+).*", "\\1", Prof))) %>% 
  fill(Day, .direction = c("down")) %>%
  fill(Credit, .direction = c("up")) %>%
  na.omit() %>%
  mutate(Start_nice = chron::times(as.numeric(Start)), 
         End_nice = chron::times(as.numeric(End)),
         Start = as.numeric(Start)*24, 
         End = as.numeric(End)*24, 
         Credit = ifelse(as.numeric(Credit)==1, 1.5, Credit), 
         BA=c(0,	0,	1,	0,	0,	1,	0,	0,	0,	0,	0,	0,	0,	0,	0,	1,	
             0,	0,	0,	0,	0,	0,	0, 0,	1,	1,	1,	0,	0,	0,	0,	0,	0,	
             0,	1,	0,	0,	1,	0,	0,	0,	0,	1,	0,	0,	0,	0,	0,	0,	0,0),
         # Business Analytics 
         BA_credits = BA*Credit,  # Total of credits per class in BA
         MG = ifelse(BA == 1, 0, 1), # Management (elective)
         MG_credits = MG * Credit,  # Total of credits per class in Management (MG)
         Day = recode(  # Recode days in number (1=Monday, 5=Friday)
           as.factor(Day),
           "Lundi" = 1,
           "Mardi" = 2,
           "Mercredi" = 3,
           "Jeudi" = 4,
           "Vendredi" = 5), 
         Moment = as.factor(paste0(
           Day, "_", as.factor(ifelse(End <=12, "AM", "PM")))))
```
## Dummies varibles 
```{r, warning=FALSE, include=FALSE, echo=FALSE}
HEC_timetables_dummies_2 <- HEC_timetables_semester_2 %>%
  rowwise(.) %>%
  mutate(!!!cols_to_make)  %>%
  ungroup %>% 
  pivot_longer(cols=starts_with("ifelse")) %>%
  filter(value!=0) %>% 
  select(-value) %>%
  fastDummies::dummy_cols(., c("Moment", "name")) %>%
  select(-Moment, -Start_nice, -End_nice, -Moment, -name, 
         -Start, -End, -Prof, -Day, -BA, -MG)

uniques_2 <-HEC_timetables_dummies_2$Class

HEC_timetables_dummies_2 <- HEC_timetables_dummies_2 %>%
  fastDummies::dummy_cols(., c("Class")) %>% 
  select(-Class) %>% t() %>% as.data.frame()

colnames(HEC_timetables_dummies_2) <- uniques_2
constraints_2 <- row.names(HEC_timetables_dummies_2)

HEC_timetables_dummies_2 <- data.frame(sapply(split(1:ncol(HEC_timetables_dummies_2), 
                                                    colnames(HEC_timetables_dummies_2)), 
                                              function(i) do.call(pmax, HEC_timetables_dummies_2[i])))
row.names(HEC_timetables_dummies_2) <- constraints_2

colnames(HEC_timetables_dummies_2) <- row.names(HEC_timetables_dummies_2 %>%
   filter(grepl("Class_", rownames(HEC_timetables_dummies_2))))
colnames(HEC_timetables_dummies_2) <- gsub("Class_","",colnames(HEC_timetables_dummies_2))

#write.xlsx(HEC_timetables_dummies_2, file = "HEC_timetables_dummies_2.xlsx")

classes_semester_2 <- colnames(HEC_timetables_dummies_2)

moments_semester_2 <- levels(HEC_timetables_semester_2$Moment)
moments_semester_2 <- sub("1_","Monday ",moments_semester_2)
moments_semester_2 <- sub("2_","Tuesday ",moments_semester_2)
moments_semester_2 <- sub("3_","Wednesday ",moments_semester_2)
moments_semester_2 <- sub("4_","Thursday ",moments_semester_2)
moments_semester_2 <- sub("5_","Friday ",moments_semester_2)
```
## Shiny App  
### UI
```{r, warning=FALSE}
ui2 <- fluidPage(# Application title
  titlePanel("HEC Timetable"),
  sidebarLayout(
    # Sidebar to insert user choices
    sidebarPanel(
      #Classes choices
      checkboxGroupInput(
        inputId = "Classes",
        label = "Classes:",
        choices = classes_semester_2,
        selected = c("Company Project in Business Analytics")),
      # Moments choices
      checkboxGroupInput(
        inputId = "Moments",
        label = "Day - AM/PM:",
        choices = moments_semester_2,
        selected = moments_semester_2),
      # ECTS choices
      sliderInput(inputId = "credits",
        min = 0, max = 42, value = 30, label = "Number of total credits"),
      sliderInput(inputId = "BA_credits",
        min = 0, max = 36, value = 12,
        label = "Number of BA credits"),
      sliderInput(inputId = "MG_credits", 
        min = 0, max = 24, value = 18, label = "Number of Electives ECTS credits")),
    # Show a plot of the generated distribution
    mainPanel(tableOutput(outputId = "timetable"))
  )
)
```
### Server
```{r, warning=FALSE}
server2 <- function(input, output, session) {
  
  output$timetable <- renderTable({
  # Credit requirement
  credits <- reactive(input$credits)
  BA_credits <- reactive(input$BA_credits)
  MG_credits <- reactive(input$MG_credits)  
    
  # Period of the day
  moments_constraints <- vector(length=length(moments_semester_2))
  Moments <- reactive(input$Moments)
  for (i in 1:length(moments_semester_2)) {
    moments_constraints[i] <- moments_semester_2[i] %in%  Moments()
  }
    
  classes_constraints <- vector(length=length(classes_semester_2))
  Classes <- reactive(input$Classes)
  for (i in 1:length(classes_semester_2)) {
    classes_constraints[i] <- classes_semester_2[i] %in%  Classes()
  }
  
  # Define parameters
  nb_of_class <- ncol(HEC_timetables_dummies_2)
  nb_of_timeslot <- dim(HEC_timetables_dummies_2 %>%
  filter(grepl("ifelse", rownames(HEC_timetables_dummies_2))))[1]
  nb_of_moment <- length(row.names(HEC_timetables_dummies_2 %>%
  filter(grepl("AM|PM", rownames(HEC_timetables_dummies_2)))))

  # Set matrix corresponding to coefficients of constraints
  f.con <- HEC_timetables_dummies_2 
  
  # Set coefficients of the objective function (min total credits taken)
  f.obj  <- HEC_timetables_dummies_2[1,] %>% unname() %>% unlist()
    
  # Set unequality/equality signs
  f.dir <- c(
    ">=", # Credits constraint
    ">=", # BA Credits constraint
    ">=", # MG Credits constraint
    rep("<=", nb_of_moment), # Chunk of the day
    rep.int("<=", nb_of_timeslot), # Time constraints
    rep(">=", nb_of_class)) # Classes choices
  
    # Set right hand side coefficients
  f.rhs <- c(
    credits(),    # Credits constraint
    BA_credits(), # BA Credits constraint
    MG_credits(), # MG Credits constraint
    moments_constraints, # Chunk of the day constraints
    rep.int(1, nb_of_timeslot), # Time constraints
    classes_constraints) # Classes constraints
    
    # Variables choices (1 if class is taken, 0 otherwise)
    binary  <- lp("min", f.obj, f.con, f.dir, f.rhs, all.bin = TRUE)$solution
    
    timetable <- cbind(as.numeric(binary), 
                       colnames(HEC_timetables_dummies_2)) %>%
      as.data.frame() %>%
      mutate(Choice = V1, Class = V2) %>%
      left_join(HEC_timetables_semester_2) %>%
      filter(Choice == 1) %>%
      mutate(
        Start = as.character(Start_nice),
        End = as.character(End_nice),
        Day = recode_factor(Day,
          `1` = "Monday",
          `2` = "Tuesday",
          `3` = "Wednesday",
          `4` = "Thursday",
          `5` = "Friday"),
        BA = recode(BA, 
          `1` = "Yes",
          `0` = "No")
      ) %>%
      select(Class, Start, End, Prof, Day, Credit, BA)
  })
}

shinyApp(ui2, server2)
```             
            
# Semester 3 
```{r, warning=FALSE, include=FALSE, echo=FALSE}
## Initial Cleaning of Data
HEC_timetables_semester_3 <- read_excel(here::here("data/HEC_timetables.xlsx"), sheet = 3, 
 col_names = c("Start", "NA", "End", "NA", "Class", "NA", "Prof"), 
 col_types = c("text", "skip", "text", "skip", "text", "skip", "text")) %>%
  mutate(Day =  Start, 
         Credit = Prof, 
         Day = gsub("[0-9]+", NA, Day), 
         Credit =as.numeric(gsub("*?([0-9]+).*", "\\1", Prof))) %>% 
  fill(Day, .direction = c("down")) %>%
  fill(Credit, .direction = c("up")) %>%
  na.omit() %>%
  mutate(Start_nice = chron::times(as.numeric(Start)), 
         End_nice = chron::times(as.numeric(End)),
         Start = as.numeric(Start)*24, 
         End = as.numeric(End)*24, 
         Credit = ifelse(as.numeric(Credit)==1, 1.5, Credit), 
         BA = c(0,1,0,0,0,1,0,0,0,0,0,0,1,0,1,0,0,0,0,0,  # Business Analytics 
                       0,0,0,0,0,0,1,0,0,0,1,1,0,0,1,0,0,0),
         BA_credits = BA*Credit,  # Total of credits per class in BA
         MG = ifelse(BA == 1, 0, 1), # Management (elective)
         MG_credits = MG * Credit,  # Total of credits per class in Management (MG)
         Day = recode(  # Recode days in number (1=Monday, 5=Friday)
           as.factor(Day),
           "Lundi" = 1,
           "Mardi" = 2,
           "Mercredi" = 3,
           "Jeudi" = 4,
           "Vendredi" = 5), 
         Moment = as.factor(paste0(
           Day, "_", as.factor(ifelse(End <=12, "AM", "PM")))))
```
## Dummies varibles 
```{r, warning=FALSE, include=FALSE, echo=FALSE}
HEC_timetables_dummies_3 <- HEC_timetables_semester_3 %>%
  rowwise(.) %>%
  mutate(!!!cols_to_make)  %>%
  ungroup %>% 
  pivot_longer(cols=starts_with("ifelse")) %>%
  filter(value!=0) %>% 
  select(-value) %>%
  fastDummies::dummy_cols(., c("Moment", "name")) %>%
  select(-Moment, -Start_nice, -End_nice, -Moment, -name, 
         -Start, -End, -Prof, -Day, -BA, -MG)

uniques_3 <-HEC_timetables_dummies_3$Class

HEC_timetables_dummies_3 <- HEC_timetables_dummies_3 %>%
  fastDummies::dummy_cols(., c("Class")) %>% 
  select(-Class) %>% t() %>% as.data.frame()

colnames(HEC_timetables_dummies_3) <- uniques_3
constraints_3 <- row.names(HEC_timetables_dummies_3)

HEC_timetables_dummies_3 <- data.frame(sapply(split(1:ncol(HEC_timetables_dummies_3), 
                                                    colnames(HEC_timetables_dummies_3)), 
                                              function(i) do.call(pmax, HEC_timetables_dummies_3[i])))
row.names(HEC_timetables_dummies_3) <- constraints_3

colnames(HEC_timetables_dummies_3) <- row.names(HEC_timetables_dummies_3 %>%
   filter(grepl("Class_", rownames(HEC_timetables_dummies_3))))
colnames(HEC_timetables_dummies_3) <- gsub("Class_","",colnames(HEC_timetables_dummies_3))

#write.xlsx(HEC_timetables_dummies_3, file = "HEC_timetables_dummies_3.xlsx")

classes_semester_3 <- colnames(HEC_timetables_dummies_3)

moments_semester_3 <- levels(HEC_timetables_semester_3$Moment)
moments_semester_3 <- sub("1_","Monday ",moments_semester_3)
moments_semester_3 <- sub("2_","Tuesday ",moments_semester_3)
moments_semester_3 <- sub("3_","Wednesday ",moments_semester_3)
moments_semester_3 <- sub("4_","Thursday ",moments_semester_3)
moments_semester_3 <- sub("5_","Friday ",moments_semester_3)
```
## Shiny App  
### UI
```{r, warning=FALSE}
ui3 <- fluidPage(# Application title
  titlePanel("HEC Timetable"),
  sidebarLayout(
    # Sidebar to insert user choices
    sidebarPanel(
      #Classes choices
      checkboxGroupInput(
        inputId = "Classes",
        label = "Classes:",
        choices = classes_semester_3),
      # Moments choices
      checkboxGroupInput(
        inputId = "Moments",
        label = "Day - AM/PM:",
        choices = moments_semester_3,
        selected = moments_semester_3),
      # ECTS choices
      sliderInput(inputId = "credits",
        min = 0, max = 42, value = 30, label = "Number of total credits"),
      sliderInput(inputId = "BA_credits",
        min = 0, max = 36, value = 12,
        label = "Number of BA credits"),
      sliderInput(inputId = "MG_credits", 
        min = 0, max = 24, value = 18, label = "Number of Electives ECTS credits")),
    # Show a plot of the generated distribution
    mainPanel(tableOutput(outputId = "timetable"))
  )
)
```
### Server
```{r, warning=FALSE}
server3 <- function(input, output, session) {
  
  output$timetable <- renderTable({
  # Credit requirement
  credits <- reactive(input$credits)
  BA_credits <- reactive(input$BA_credits)
  MG_credits <- reactive(input$MG_credits)  
    
  # Period of the day
  moments_constraints <- vector(length=length(moments_semester_3))
  Moments <- reactive(input$Moments)
  for (i in 1:length(moments_semester_3)) {
    moments_constraints[i] <- moments_semester_3[i] %in%  Moments()
  }
    
  classes_constraints <- vector(length=length(classes_semester_3))
  Classes <- reactive(input$Classes)
  for (i in 1:length(classes_semester_3)) {
    classes_constraints[i] <- classes_semester_3[i] %in%  Classes()
  }
  
  # Define parameters
  nb_of_class <- ncol(HEC_timetables_dummies_3)
  nb_of_timeslot <- dim(HEC_timetables_dummies_3 %>%
  filter(grepl("ifelse", rownames(HEC_timetables_dummies_3))))[1]
  nb_of_moment <- length(row.names(HEC_timetables_dummies_3 %>%
  filter(grepl("AM|PM", rownames(HEC_timetables_dummies_3)))))

  # Set matrix corresponding to coefficients of constraints
  f.con <- HEC_timetables_dummies_3 
  
  # Set coefficients of the objective function (min total credits taken)
  f.obj  <- HEC_timetables_dummies_3[1,] %>% unname() %>% unlist()
    
  # Set unequality/equality signs
  f.dir <- c(
    ">=", # Credits constraint
    ">=", # BA Credits constraint
    ">=", # MG Credits constraint
    rep("<=", nb_of_moment), # Chunk of the day
    rep.int("<=", nb_of_timeslot), # Time constraints
    rep(">=", nb_of_class)) # Classes choices
  
    # Set right hand side coefficients
  f.rhs <- c(
    credits(),    # Credits constraint
    BA_credits(), # BA Credits constraint
    MG_credits(), # MG Credits constraint
    moments_constraints, # Chunk of the day constraints
    rep.int(1, nb_of_timeslot), # Time constraints
    classes_constraints) # Classes constraints
    
    # Variables choices (1 if class is taken, 0 otherwise)
    binary  <- lp("min", f.obj, f.con, f.dir, f.rhs, all.bin = TRUE)$solution
    
    timetable <- cbind(as.numeric(binary), 
                       colnames(HEC_timetables_dummies_3)) %>%
      as.data.frame() %>%
      mutate(Choice = V1, Class = V2) %>%
      left_join(HEC_timetables_semester_3) %>%
      filter(Choice == 1) %>%
      mutate(
        Start = as.character(Start_nice),
        End = as.character(End_nice),
        Day = recode_factor(Day,
          `1` = "Monday",
          `2` = "Tuesday",
          `3` = "Wednesday",
          `4` = "Thursday",
          `5` = "Friday"),
        BA = recode(BA, 
          `1` = "Yes",
          `0` = "No")
      ) %>%
      select(Class, Start, End, Prof, Day, Credit, BA)
  })
}

shinyApp(ui3, server3)
```                        


# Dummies variables (3 semesters at once) _ISSUE
#```{r, warning=FALSE, include=FALSE, echo=FALSE}
# Replication 5 times all the hours slots from 8 to 19
hours_of_day <- rep(9:19, 15)

# Replicate 11 times Monday (1), Tuesday, Wednesday, Thursday and Friday (5)
days_of_week <-rep(rep(1, 11), rep(2, 11), rep(3, 11), rep(4, 11), rep(5, 11), 3)

# Replication of 55 timeslot each semester
semester <- c(rep(1L, 55), rep(2L, 55), rep(3L, 55))

# Create a list with all conditions for hours and day combinations
cols_to_make_all <- rlang::parse_exprs(
  paste0('ifelse(End >=', hours_of_day,
         '& Start <', hours_of_day, 
         '& Day ==', days_of_week,
    ',1,0)'
  )
)

# Merge all 3 timetables into a unique one and add "Semester" information
HEC_timetables <- rbind(HEC_timetables_semester_1 %>% mutate(Semester=1), 
                        HEC_timetables_semester_2 %>% mutate(Semester=2), 
                        HEC_timetables_semester_3 %>% mutate(Semester=3)) 

################ CREATION OF DUMMY VARIABLES USED 
##########################ISSUE HERE WITH ifelse(...)
HEC_timetables_dummies <- HEC_timetables %>% 
  rowwise() %>% 
  mutate(!!!cols_to_make_all)  %>%
  ungroup %>% 
  pivot_longer(cols=starts_with("ifelse")) %>%
  filter(value!=0) %>% 
  select(-value) %>%
  fastDummies::dummy_cols(., c("Moment", "name")) %>%
  select(-Moment, -Start_nice, -End_nice, -Moment, -name, 
         -Start, -End, -Prof, -Day, -BA, -MG)

uniques <-HEC_timetables_dummies$Class

HEC_timetables_dummies <- HEC_timetables_dummies %>%
  fastDummies::dummy_cols(., c("Class")) %>% 
  select(-Class) %>% t() %>% as.data.frame()

colnames(HEC_timetables_dummies) <- uniques
constraints <- row.names(HEC_timetables_dummies)

HEC_timetables_dummies <- data.frame(sapply(split(1:ncol(HEC_timetables_dummies), 
                                                    colnames(HEC_timetables_dummies)), 
                                              function(i) do.call(pmax, HEC_timetables_dummies[i])))
row.names(HEC_timetables_dummies) <- constraints

colnames(HEC_timetables_dummies) <- row.names(HEC_timetables_dummies %>%
   filter(grepl("Class_", rownames(HEC_timetables_dummies))))
colnames(HEC_timetables_dummies) <- gsub("Class_","",colnames(HEC_timetables_dummies))

#write.xlsx(HEC_timetables_dummies, file = "HEC_timetables_dummies.xlsx")
```
