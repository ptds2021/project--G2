---
title: "Goals and Impacts"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r, warning=FALSE, include=FALSE, echo=FALSE}
source(here::here("scripts/setup.R"))

## Initial Cleaning of Data

HEC_timetables_raw <- read_excel(here::here("data/HEC_timetables.xlsx"), 
 col_names = c("Start", "NA", "End", "NA", "Class", "NA", "Prof"), 
 col_types = c("text", "skip", "numeric", "skip", "text", "skip", "text"))

HEC_timetables_raw <- HEC_timetables_raw %>% mutate(Day=Start, Credit=Prof)
HEC_timetables_raw$Day <- gsub("[0-9]+", NA, HEC_timetables_raw$Day) 
HEC_timetables_raw$Credit <- as.numeric(gsub("*?([0-9]+).*", "\\1", HEC_timetables_raw$Prof)) 

HEC_timetables <- HEC_timetables_raw %>% 
  fill(Day, .direction = c("down")) %>%
  fill(Credit, .direction = c("up")) %>%
  na.omit() %>%
  mutate(Start = as.numeric(Start)*24, End = as.numeric(End)*24) %>%
  mutate(Credit = ifelse(as.numeric(Credit)==1, 1.5, Credit)) 

rm(HEC_timetables_raw)
```

```{r, warning=FALSE, include=FALSE, echo=FALSE}
### Business Analytics variables 
# Imputed manually if a class if in BA (dummy = 1) or not (dummy = 0)
HEC_timetables$BA <- c(0,1,0,0,0,1,0,0,0,0,0,0,1,0,1,0,0,0,0,0,
                       0,0,0,0,0,0,1,0,0,0,1,1,0,0,1,0,0,0)

# Total of credits per class in BA
HEC_timetables$BA_credits <- HEC_timetables$BA*HEC_timetables$Credit

### Elective (in Management) variables 
# Reverse of dummy BA -> if a class if in MG (dummy = 1) or not (dummy = 0)
HEC_timetables <- HEC_timetables %>% mutate(MG=ifelse(BA==1, 0, 1))
# Total of credits per class in Management (MG)
HEC_timetables$MG_credits <- HEC_timetables$MG*HEC_timetables$Credit

################ CREATION OF MOST DUMMY VARIABLES USED 
# USER CHOICE - Creation of dummy variables for each class
HEC_timetables <- fastDummies::dummy_cols(HEC_timetables, c("Class"))

HEC_timetables_dummies <- HEC_timetables %>%
  mutate(
    # USER CHOICE - Creation of dummy variable for each period
      # Monday
      "Monday_Morning" = ifelse(End <=12 & Day == "Lundi", 1, 0), 
      "Monday_Lunch" = ifelse(Start > 12 & End <= 14 & Day == "Lundi", 1, 0), 
      "Monday_Afternoon" = ifelse(Start > 14 & Day == "Lundi", 1, 0), 
      # Tuesday
      "Tuesday_Morning" = ifelse(End <=12 & Day == "Mardi", 1, 0), 
      "Tuesday_Lunch" = ifelse(Start > 12 & End <= 14 & Day == "Mardi", 1, 0), 
      "Tuesday_Afternoon" = ifelse(Start > 14 & Day == "Mardi", 1, 0), 
      # Wednesday
      "Wednesday_Morning" = ifelse(End <=12 & Day == "Mercredi", 1, 0), 
      "Wednesday_Lunch" = ifelse(Start > 12 & End <= 14 & Day == "Mercredi", 1, 0),
      "Wednesday_Afternoon" = ifelse(Start > 14 & Day == "Mercredi", 1, 0), 
      # Thursday
      "Thursday_Morning" = ifelse(End <=12 & Day == "Jeudi", 1, 0), 
      "Thursday_Lunch" = ifelse(Start > 12 & End <= 14 & Day == "Jeudi", 1, 0), 
      "Thursday_Afternoon" = ifelse(Start > 14 & Day == "Jeudi", 1, 0), 
      # Friday
      "Friday_Morning" = ifelse(End <=12 & Day == "Vendredi", 1, 0), 
      "Friday_Lunch" = ifelse(Start > 12 & End <= 14 & Day == "Vendredi", 1, 0), 
      "Friday_Afternoon" = ifelse(Start > 14 & Day == "Vendredi", 1, 0), 
     
    # CONSTRAINTS - Creation of unique time slot dummy (Day-Start-End)
      # Monday
         "Monday_8-9H"=ifelse(Start < 9 & End >= 9 & Day=="Lundi", 1, 0), 
         "Monday_9-10H"=ifelse(Start < 10 & End >= 10 & Day=="Lundi", 1, 0),
         "Monday_10-11H"=ifelse(Start < 11 & End >= 11 & Day=="Lundi", 1, 0),
         "Monday_11-12H"=ifelse(Start < 12 & End >= 12 & Day=="Lundi", 1, 0), 
         "Monday_12-13H"=ifelse(Start < 13 & End >= 13 & Day=="Lundi", 1, 0),
         "Monday_13-14H"=ifelse(Start < 14 & End >= 14 & Day=="Lundi", 1, 0),
         "Monday_14-15H"=ifelse(Start < 15 & End >= 15 & Day=="Lundi", 1, 0), 
         "Monday_15-16H"=ifelse(Start < 16 & End >= 16 & Day=="Lundi", 1, 0),
         "Monday_16-17H"=ifelse(Start < 17 & End >= 17 & Day=="Lundi", 1, 0),
         "Monday_17-18H"=ifelse(Start < 18 & End >= 18 & Day=="Lundi", 1, 0),
         "Monday_18-19H"=ifelse(Start < 19 & End >= 19 & Day=="Lundi", 1, 0), 
      # Tuesday
         "Tuesday_8-9H"=ifelse(Start < 9 & End >= 9 & Day=="Mardi", 1, 0), 
         "Tuesday_9-10H"=ifelse(Start < 10 & End >= 10 & Day=="Mardi", 1, 0),
         "Tuesday_10-11H"=ifelse(Start < 11 & End >= 11 & Day=="Mardi", 1, 0),
         "Tuesday_11-12H"=ifelse(Start < 12 & End >= 12 & Day=="Mardi", 1, 0), 
         "Tuesday_12-13H"=ifelse(Start < 13 & End >= 13 & Day=="Mardi", 1, 0),
         "Tuesday_13-14H"=ifelse(Start < 14 & End >= 14 & Day=="Mardi", 1, 0),
         "Tuesday_14-15H"=ifelse(Start < 15 & End >= 15 & Day=="Mardi", 1, 0), 
         "Tuesday_15-16H"=ifelse(Start < 16 & End >= 16 & Day=="Mardi", 1, 0),
         "Tuesday_16-17H"=ifelse(Start < 17 & End >= 17 & Day=="Mardi", 1, 0),
         "Tuesday_17-18H"=ifelse(Start < 18 & End >= 18 & Day=="Mardi", 1, 0),
         "Tuesday_18-19H"=ifelse(Start < 19 & End >= 19 & Day=="Mardi", 1, 0), 
      # Wednesday
         "Wednesday_8-9H"=ifelse(Start < 9 & End >= 9 & Day=="Mercredi", 1, 0), 
         "Wednesday_9-10H"=ifelse(Start < 10 & End >= 10 & Day=="Mercredi", 1, 0),
         "Wednesday_10-11H"=ifelse(Start < 11 & End >= 11 & Day=="Mercredi", 1, 0),
         "Wednesday_11-12H"=ifelse(Start < 12 & End >= 12 & Day=="Mercredi", 1, 0), 
         "Wednesday_12-13H"=ifelse(Start < 13 & End >= 13 & Day=="Mercredi", 1, 0),
         "Wednesday_13-14H"=ifelse(Start < 14 & End >= 14 & Day=="Mercredi", 1, 0),
         "Wednesday_14-15H"=ifelse(Start < 15 & End >= 15 & Day=="Mercredi", 1, 0), 
         "Wednesday_15-16H"=ifelse(Start < 16 & End >= 16 & Day=="Mercredi", 1, 0),
         "Wednesday_16-17H"=ifelse(Start < 17 & End >= 17 & Day=="Mercredi", 1, 0),
         "Wednesday_17-18H"=ifelse(Start < 18 & End >= 18 & Day=="Mercredi", 1, 0),
         "Wednesday_18-19H"=ifelse(Start < 19 & End >= 19 & Day=="Mercredi", 1, 0), 
      # Thursday
         "Thursday_8-9H"=ifelse(Start < 9 & End >= 9 & Day=="Jeudi", 1, 0), 
         "Thursday_9-10H"=ifelse(Start < 10 & End >= 10 & Day=="Jeudi", 1, 0),
         "Thursday_10-11H"=ifelse(Start < 11 & End >= 11 & Day=="Jeudi", 1, 0),
         "Thursday_11-12H"=ifelse(Start < 12 & End >= 12 & Day=="Jeudi", 1, 0), 
         "Thursday_12-13H"=ifelse(Start < 13 & End >= 13 & Day=="Jeudi", 1, 0),
         "Thursday_13-14H"=ifelse(Start < 14 & End >= 14 & Day=="Jeudi", 1, 0),
         "Thursday_14-15H"=ifelse(Start < 15 & End >= 15 & Day=="Jeudi", 1, 0), 
         "Thursday_15-16H"=ifelse(Start < 16 & End >= 16 & Day=="Jeudi", 1, 0),
         "Thursday_16-17H"=ifelse(Start < 17 & End >= 17 & Day=="Jeudi", 1, 0),
         "Thursday_17-18H"=ifelse(Start < 18 & End >= 18 & Day=="Jeudi", 1, 0),
         "Thursday_18-19H"=ifelse(Start < 19 & End >= 19 & Day=="Jeudi", 1, 0), 
      # Friday
         "Friday_8-9H"=ifelse(Start < 9 & End >= 9 & Day=="Vendredi", 1, 0), 
         "Friday_9-10H"=ifelse(Start < 10 & End >= 10 & Day=="Vendredi", 1, 0),
         "Friday_10-11H"=ifelse(Start < 11 & End >= 11 & Day=="Vendredi", 1, 0),
         "Friday_11-12H"=ifelse(Start < 12 & End >= 12 & Day=="Vendredi", 1, 0), 
         "Friday_12-13H"=ifelse(Start < 13 & End >= 13 & Day=="Vendredi", 1, 0),
         "Friday_13-14H"=ifelse(Start < 14 & End >= 14 & Day=="Vendredi", 1, 0),
         "Friday_14-15H"=ifelse(Start < 15 & End >= 15 & Day=="Vendredi", 1, 0), 
         "Friday_15-16H"=ifelse(Start < 16 & End >= 16 & Day=="Vendredi", 1, 0),
         "Friday_16-17H"=ifelse(Start < 17 & End >= 17 & Day=="Vendredi", 1, 0),
         "Friday_17-18H"=ifelse(Start < 18 & End >= 18 & Day=="Vendredi", 1, 0),
         "Friday_18-19H"=ifelse(Start < 19 & End >= 19 & Day=="Vendredi", 1, 0))
```

```{r, warning=FALSE}
# Define parameters
nb_of_class <- length(HEC_timetables$Class)
nb_of_timeslot <- 55L # 11 time slot per day, times 5 days a week 

# Set matrix corresponding to coefficients of constraints
f.con <- HEC_timetables_dummies %>% 
  # Removed colums that are not needed in the constraints
  select(-Start, -End, -Class, -Prof, -Day, -BA, -MG) %>% t()

# Set coefficients of the objective function (min total credits taken)
f.obj  <- HEC_timetables_dummies$Credit
```

```{r, warning=FALSE}
# Set unequality/equality signs 
f.dir <- c(
  ### USER CHOICES
  #### CREDITS -> Should be greater than threshold given by user
  ">=", # Credits constraint 
  ">=", # BA Credits constraint
  ">=", # MG Credits constraint
  
  #### CLASS -> By default possible, put == (double) instead if WANT the class 
  "<=", # "Advanced issues in International and European Tax Law"
  "<=", # "Algorithms for Business Intelligence and Digital Marketing"
  "<=", # "Animal Communication and Parasitism"
  "<=", # "Behavioral Economics"
  "<=", # "Business and Human Rights"
  "<=", # "Business and Society - Corporate Sustainability"
  "<=", # "Business Case en Marketing"
  "<=", # "Datascience for Marketing"
  "<=", # "Digitalisation of Purchasing and B to B Sales"
  "<=", # "Entrepreneurship and Strategy"
  "<=", # "Entrepreneurship, Innovation and Control Systems"
  "<=", # "Experimental Methods"
  "<=", # "Fraud and Business Process Analytics"
  "<=", # "Global Marketing"
  "<=", # "Heuristic Decision Making Strategies"
  "<=", # "Human Behavior and Evolutionary Inference"
  "<=", # "Individual Behavior in the Digital Environment"
  "<=", # "Integrated Marketing Communication (MScM)"
  "<=", # "La recherche dans tous ses états"
  "<=", # "Leadership Development"
  "<=", # "Luxury Marketing"
  "<=", # "Major Transition in Evolution"
  "<=", # "Managerial Decision Making"
  "<=", # "Normes comptables internationales (IFRS)"
  "<=", # "Production Control"
  "<=", # "Programming Tools in Data Science"
  "<=", # "Project in Data Analytics"
  "<=", # "Risk Analytics"
  "<=", # "Strategic Management Control Systems"
  "<=", # "Stratégies digitales"
  "<=", # "Stratégies légales internationales I"
  "<=", # "Stratégies légales internationales II"
  "<=", # "Strategy and Development Modes"
  "<=", # "Strategy in Digital Markets"
  "<=", # "Supply Chain Management and its Latest Trends"
  "<=", # "Text Mining"
  "<=", # "Unethical Decision Making - Advanced"
  "<=", # "Unethical Decision Making - Basics" 
  
  #### CHUNK OF THE DAY/WEEK 
  "<=", # Monday Morning
  "<=", # Monday Lunch
  "<=", # Monday Afternoon
  "<=", # Tuesday Morning
  "<=", # Tuesday Lunch
  "<=", # Tuesday Afternoon
  "<=", # Wednesday Morning
  "<=", # Wednesday Lunch
  "<=", # Wednesday Afternoon
  "<=", # Thursday Morning
  "<=", # Thursday Lunch
  "<=", # Thursday Afternoon
  "<=", # Friday Morning
  "<=", # Friday Lunch
  "<=", # Friday Afternoon
           
  ### TIME CONSTRAINTS     
  rep.int("<=", nb_of_timeslot) # Time slot constraint <= 1 (no overlap allowed)
) 
```

```{r, warning=FALSE}
# Set right hand side coefficients
f.rhs <- c(
  ### USER CHOICES
  #### CREDITS -> Should be greater than threshold given by user
  30, # Credits constraint
  15, # BA Credits constraint
  15, # MG Credits constraint
  
  #### CLASS 
  rep.int(1, nb_of_class), # Diagonal matrix for each class 

  #### CHUNK OF THE DAY/WEEK -> By default allowed, put 0 if don't want 
  1, # Monday Morning class
  1, # Lunch class
  1, # Monday Afternoon class
  1, # Tuesday Morning class
  1, # Tuesday Lunch class
  1, # Tuesday Afternoon class
  1, # Wednesday Morning class
  1, # Wednesday Lunch class
  1, # Wednesday Afternoon class
  1, # Thursday Morning class
  1, # Thursday Lunch class
  1, # Thursday Afternoon class
  1, # Friday Morning class
  1, # Friday Lunch class
  1, # Friday Afternoon class
           
  ### TIME CONSTRAINTS         
  rep.int(1, nb_of_timeslot) # Time slot constraint <= 1 (no overlap allowed)
)
```

```{r, warning=FALSE}
# Import lpSolve package
library(lpSolve)

# Final value (z)
solution <- lp("min", f.obj, f.con, f.dir, f.rhs, all.bin = TRUE)

# Variables choices (1 if class is taken, 0 otherwise)
choices <- lp("min", f.obj, f.con, f.dir, f.rhs, all.bin = TRUE)$solution %>% 
  as.data.frame() %>%
  cbind(HEC_timetables) %>% 
  filter(.>0) %>%
  select(Class, Start, End, Prof, Day, Credit, BA)
```