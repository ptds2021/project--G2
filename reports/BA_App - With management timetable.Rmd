---
title: "Shiny App HEC BA timetable"
output: html_notebook
editor_options: 
  markdown: 
    wrap: 72
runtime: shiny
---

```{r, warning=FALSE}
source(here::here("scripts/setup.R"))
library("pkggroup2")
library("shiny")
# Obtain the dummies and all necessary variables from this package
pkggroup2::dummy_creation()
```

```{r, warning=FALSE, error=FALSE}
ui <- navbarPage(theme = shinytheme("cerulean"),
  "HEC Lausanne - Timetable suggestions for Management students",
  helpText("If no timetable is displayed, try to relax some constraints.
           Don't take too many credits per semester, a standard load is 30.
           Make sure to have over semester 2 & 3 at least 36 core credits."),
  tabPanel(
    "Semester 1",
    sidebarPanel(
      # ECTS choices
      sliderInput(
        inputId = "credits_1",
        min = 0,
        max = 42,
        value = 30,
        label = "Total credits"),
      sliderInput(
        inputId = "CORE_credits_1",
        min = 0,
        max = 36,
        value = 18,
        label = "Mandatory credits"),
      sliderInput(
        inputId = "ELECTIVE_credits_1",
        min = 0,
        max = 24,
        value = 12,
        label = "Elective credits"),
      #Classes choices
      pickerInput(
        inputId = "Classes_1",
        label = "Classes:",
        choices = classes_semester[[1]],
        selected = classes_mandatory[[1]], # Refer to mandatory classes
        options = list(
          `actions-box` = TRUE, size = 10,
          `selected-text-format` = "count > 3"),
        multiple = TRUE),
      # Moments choices
      pickerInput(
        inputId = "Moments_1",
        label = "Day - AM/PM:",
        choices = moments_semester[[1]],
        selected = moments_semester[[1]],
        options = list(
          `actions-box` = TRUE, size = 10,
          `selected-text-format` = "count > 3"),
        multiple = TRUE)),
    # Show a plot of the generated distribution
    mainPanel(mainPanel(tabsetPanel(type = "tabs",
                  tabPanel("Visual Timetable", plotOutput("timetable_1_graph")),
                  tabPanel("More detailed Timetable", tableOutput("timetable_1"))), 
                  style='width: 100%'))),
  tabPanel(
    "Semester 2",
   sidebarPanel(
     # ECTS choices
      sliderInput(inputId = "credits_2",
        min = 0, max = 42, value = 30, label = "Total credits"),
      sliderInput(inputId = "CORE_credits_2",
        min = 0, max = 36, value = 12, label = "Mandatory credits"),
      sliderInput(inputId = "ELECTIVE_credits_2",
        min = 0, max = 24, value = 18, label = "Elective credits"),
    #Classes choices
      pickerInput(
        inputId = "Classes_2",
        label = "Classes:",
        choices = classes_semester[[2]],
        selected = classes_mandatory[[2]],
        options = list(
          `actions-box` = TRUE, size = 10,
          `selected-text-format` = "count > 3"),
        multiple = TRUE),
      # Moments choices
      pickerInput(
        inputId = "Moments_2",
        label = "Day - AM/PM:",
        choices = moments_semester[[2]],
        selected = moments_semester[[2]],
        options = list(
          `actions-box` = TRUE, size = 10,
          `selected-text-format` = "count > 3"),
        multiple = TRUE)),
    # Show a plot of the generated distribution
    mainPanel(mainPanel(tabsetPanel(type = "tabs",
                  tabPanel("Visual Timetable", plotOutput("timetable_2_graph")),
                  tabPanel("More detailed Timetable", tableOutput("timetable_2"))), 
                  style='width: 100%'))),
  tabPanel(
    "Semester 3",
    sidebarPanel(
      # ECTS choices
      sliderInput(inputId = "credits_3",
        min = 0, max = 42, value = 30, label = "Total credits"),
      sliderInput(inputId = "CORE_credits_3",
        min = 0, max = 36, value = 12, label = "Mandatory credits"),
      sliderInput(inputId = "ELECTIVE_credits_3",
        min = 0, max = 24, value = 18, label = "Elective credits"),

      #Classes choices
      pickerInput(
        inputId = "Classes_3",
        label = "Classes:",
        choices = classes_semester[[3]],
        selected = classes_mandatory[[3]],
        options = list(
          `actions-box` = TRUE, size = 10,
          `selected-text-format` = "count > 3"),
        multiple = TRUE),
      # Moments choices
      pickerInput(
        inputId = "Moments_3",
        label = "Day - AM/PM:",
        choices = moments_semester[[3]],
        selected = moments_semester[[3]],
        options = list(
          `actions-box` = TRUE, size = 10,
          `selected-text-format` = "count > 3"),
        multiple = TRUE)),
    # Show a plot of the generated distribution
    mainPanel(mainPanel(tabsetPanel(type = "tabs",
                  tabPanel("Visual Timetable", plotOutput("timetable_3_graph")),
                  tabPanel("More detailed Timetable", tableOutput("timetable_3"))), 
                  style='width: 100%'))))
```

```{r, warning=FALSE, error=FALSE}
server <- function(input, output, session) {
  
  for (i in 1:length(moments_semester[[1]])) {
    moments_constraints[[1]][i] <- moments_semester[[1]][i] %in% reactive(input$Moments_1)()}

  # Classes chosen
  for (i in 1:length(classes_semester[[1]])) {
    classes_constraints[[1]][i] <- classes_semester[[1]][i] %in% reactive(input$Classes_1)()}
    
  # Right hand side of constraints based on user inputs 
  f.rhs_1 <- c(
   reactive(input$credits_1)(),          # Credits constraint
   reactive(input$CORE_credits_1)(),     # CORE Credits constraint
   reactive(input$ELECTIVE_credits_1)(), # ELECTIVE Credits constraint
   length(classes_constraints[[1]])*moments_constraints[[1]], # Chunk of the day constraints
   rep.int(1, nb_of_timeslot[[1]]),      # Time constraints
   classes_constraints[[1]])             # Classes constraints
  
  
  output$timetable_1 <- renderTable({ 
  ## ALL REACTIVE INPUTS FROM USER
  # Period of the day
  # Optimization of classes in form of a textual timetable
  class_1 <- pkggroup2::class_optim(1, f.obj, f.con, f.dir, f.rhs_1)
  pkggroup2::display_text_timetable(1, class_1)
  
  })
  
  output$timetable_1_graph <- renderPlot({
  ## ALL REACTIVE INPUTS FROM USER
  # Period of the day
  for (i in 1:length(moments_semester[[1]])) {
    moments_constraints[[1]][i] <- moments_semester[[1]][i] %in% reactive(input$Moments_1)()}

  # Classes chosen
  for (i in 1:length(classes_semester[[1]])) {
    classes_constraints[[1]][i] <- classes_semester[[1]][i] %in% reactive(input$Classes_1)()}
    
  # Right hand side of constraints based on user inputs 
  f.rhs_1 <- c(
   reactive(input$credits_1)(),          # Credits constraint
   reactive(input$CORE_credits_1)(),     # CORE Credits constraint
   reactive(input$ELECTIVE_credits_1)(), # ELECTIVE Credits constraint
   length(classes_constraints[[1]])*moments_constraints[[1]], # Chunk of the day constraints
   rep.int(1, nb_of_timeslot[[1]]),      # Time constraints
   classes_constraints[[1]])             # Classes constraints
     
  # Optimization of classes in form of a visual timetable
  class_1 <- pkggroup2::class_optim(1, f.obj, f.con, f.dir, f.rhs_1)
  pkggroup2::display_visual_timetable(1, class_1)
  
  })

  output$timetable_2 <- renderTable({ 
  ## ALL REACTIVE INPUTS FROM USER
  # Period of the day
  for (i in 1:length(moments_semester[[2]])) {
    moments_constraints[[2]][i] <- moments_semester[[2]][i] %in% reactive(input$Moments_2)()}

  # Classes chosen
  for (i in 1:length(classes_semester[[2]])) {
    classes_constraints[[2]][i] <- classes_semester[[2]][i] %in% reactive(input$Classes_2)()}
    
  # Right hand side of constraints based on user inputs 
  f.rhs_2 <- c(
   reactive(input$credits_2)(),          # Credits constraint
   reactive(input$CORE_credits_2)(),     # CORE Credits constraint
   reactive(input$ELECTIVE_credits_2)(), # ELECTIVE Credits constraint
   length(classes_constraints[[2]])*moments_constraints[[2]], # Chunk of the day constraints
   rep.int(1, nb_of_timeslot[[2]]),      # Time constraints
   classes_constraints[[2]])             # Classes constraints
     
  # Optimization of classes in form of a textual timetable
  class_2 <- pkggroup2::class_optim(2, f.obj, f.con, f.dir, f.rhs_2)
  pkggroup2::display_text_timetable(2, class_2)
  
  })
  
  output$timetable_2_graph <- renderPlot({
  ## ALL REACTIVE INPUTS FROM USER
  # Period of the day
  for (i in 1:length(moments_semester[[2]])) {
    moments_constraints[[2]][i] <- moments_semester[[2]][i] %in% reactive(input$Moments_2)()}

  # Classes chosen
  for (i in 1:length(classes_semester[[2]])) {
    classes_constraints[[2]][i] <- classes_semester[[2]][i] %in% reactive(input$Classes_2)()}
    
  # Right hand side of constraints based on user inputs 
  f.rhs_2 <- c(
   reactive(input$credits_2)(),          # Credits constraint
   reactive(input$CORE_credits_2)(),     # CORE Credits constraint
   reactive(input$ELECTIVE_credits_2)(), # ELECTIVE Credits constraint
   length(classes_constraints[[2]])*moments_constraints[[2]], # Chunk of the day constraints
   rep.int(1, nb_of_timeslot[[2]]),      # Time constraints
   classes_constraints[[2]])             # Classes constraints
     
  # Optimization of classes in form of a visual timetable
  class_2 <- pkggroup2::class_optim(2, f.obj, f.con, f.dir, f.rhs_2)
  pkggroup2::display_visual_timetable(2, class_2)
  
  })
  
  output$timetable_3 <- renderTable({ 
  ## ALL REACTIVE INPUTS FROM USER
  # Period of the day
  for (i in 1:length(moments_semester[[3]])) {
    moments_constraints[[3]][i] <- moments_semester[[3]][i] %in% reactive(input$Moments_3)()}

  # Classes chosen
  for (i in 1:length(classes_semester[[3]])) {
    classes_constraints[[3]][i] <- classes_semester[[3]][i] %in% reactive(input$Classes_3)()}
    
  # Right hand side of constraints based on user inputs 
  f.rhs_3 <- c(
   reactive(input$credits_3)(),          # Credits constraint
   reactive(input$CORE_credits_3)(),     # CORE Credits constraint
   reactive(input$ELECTIVE_credits_3)(), # ELECTIVE Credits constraint
   length(classes_constraints[[3]])*moments_constraints[[3]], # Chunk of the day constraints
   rep.int(1, nb_of_timeslot[[3]]),      # Time constraints
   classes_constraints[[3]])             # Classes constraints
     
  # Optimization of classes in form of a textual timetable
  class_3 <- pkggroup2::class_optim(3, f.obj, f.con, f.dir, f.rhs_3)
  pkggroup2::display_text_timetable(3, class_3)
  
  })
  
  output$timetable_3_graph <- renderPlot({
  ## ALL REACTIVE INPUTS FROM USER
  # Period of the day
  for (i in 1:length(moments_semester[[3]])) {
    moments_constraints[[3]][i] <- moments_semester[[3]][i] %in% reactive(input$Moments_3)()}

  # Classes chosen
  for (i in 1:length(classes_semester[[3]])) {
    classes_constraints[[3]][i] <- classes_semester[[3]][i] %in% reactive(input$Classes_3)()}
    
  # Right hand side of constraints based on user inputs 
  f.rhs_3 <- c(
   reactive(input$credits_3)(),          # Credits constraint
   reactive(input$CORE_credits_3)(),     # CORE Credits constraint
   reactive(input$ELECTIVE_credits_3)(), # ELECTIVE Credits constraint
   length(classes_constraints[[3]])*moments_constraints[[3]], # Chunk of the day constraints
   rep.int(1, nb_of_timeslot[[3]]),      # Time constraints
   classes_constraints[[3]])             # Classes constraints
     
  # Optimization of classes in form of a visual timetable
  class_3 <- pkggroup2::class_optim(3, f.obj, f.con, f.dir, f.rhs_3)
  pkggroup2::display_visual_timetable(3, class_3)
  
  })
}
```

```{r}
shinyApp(ui, server)
```
